<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Secretaria IA{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', path='css/style.css') }}" rel="stylesheet">
    <script>
        // Pre-load theme to prevent flash
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar collapsed">
            <div class="sidebar-brand d-flex justify-content-center align-items-center px-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-robot"></i>
                    <span>Secretaria IA</span>
                </div>
            </div>
            <div class="nav flex-column">
                <a href="/admin"
                    class="nav-link {% if request.url.path == '/admin' or request.url.path == '/admin/' %}active{% endif %}">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/agenda" class="nav-link {% if 'agenda' in request.url.path %}active{% endif %}">
                    <i class="bi bi-calendar-check"></i>
                    <span>Agenda</span>
                </a>
                <a href="/admin/profissionais"
                    class="nav-link {% if 'profissionais' in request.url.path %}active{% endif %}">
                    <i class="bi bi-people"></i>
                    <span>Profissionais</span>
                </a>
                <a href="/admin/agentes" class="nav-link {% if 'agentes' in request.url.path %}active{% endif %}">
                    <i class="bi bi-robot"></i>
                    <span>Multiagente</span>
                </a>
                <a href="/admin/agente-simples"
                    class="nav-link {% if 'agente-simples' in request.url.path %}active{% endif %}">
                    <i class="bi bi-person-badge"></i>
                    <span>Agente Simples</span>
                </a>
                <a href="/admin/prompts" class="nav-link {% if 'prompts' in request.url.path %}active{% endif %}">
                    <i class="bi bi-chat-square-text"></i>
                    <span>Prompts (Legado)</span>
                </a>
                <a href="/admin/rag" class="nav-link {% if request.url.path == '/admin/rag' %}active{% endif %}">
                    <i class="bi bi-database"></i>
                    <span>Base de Conhecimento</span>
                </a>
                <a href="/admin/perguntas-sem-resposta"
                    class="nav-link {% if 'perguntas-sem-resposta' in request.url.path %}active{% endif %}">
                    <i class="bi bi-question-circle"></i>
                    <span>Perguntas s/ Resposta</span>
                </a>
                <a href="/admin/pipeline" class="nav-link {% if 'pipeline' in request.url.path %}active{% endif %}">
                    <i class="bi bi-kanban"></i>
                    <span>Pipeline</span>
                </a>
                <a href="/admin/configuracoes"
                    class="nav-link {% if 'configuracoes' in request.url.path %}active{% endif %}">
                    <i class="bi bi-gear"></i>
                    <span>Configuracoes</span>
                </a>
                <a class="nav-link mt-4" href="/" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>API Status</span>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content flex-grow-1 expanded position-relative d-flex flex-column">
            <!-- Header -->
            <header class="main-header glass d-flex justify-content-between align-items-center px-4 py-3">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">Secretaria IA</h5>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <button id="themeToggle" class="theme-toggle" title="Alternar Tema">
                        <i class="bi bi-moon-stars"></i>
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="flex-grow-1">
                {% block content %}{% endblock %}
            </div>

            <!-- Footer -->
            <footer class="main-footer glass text-center py-3 mt-4">
                <small class="text-secondary">&copy; 2025 Secretaria IA. Todos os direitos reservados.</small>
            </footer>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Toggle Logic
        const themeToggleBtn = document.getElementById('themeToggle');
        const themeIcon = themeToggleBtn.querySelector('i');

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.classList.remove('bi-moon-stars');
                themeIcon.classList.add('bi-sun');
            } else {
                themeIcon.classList.remove('bi-sun');
                themeIcon.classList.add('bi-moon-stars');
            }
        }

        // Set initial icon
        updateThemeIcon(savedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            applyBranding(newTheme); // Apply branding for new theme
        });

        // Branding Logic
        let systemConfigs = {};

        function hexToRgb(hex) {
            // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function (m, r, g, b) {
                return r + r + g + g + b + b;
            });

            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ?
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
        }

        function applyBranding(theme) {
            const configs = JSON.parse(localStorage.getItem('systemConfigs') || '{}');
            const root = document.documentElement;

            // System Name
            const name = configs.system_name || 'Secretaria IA';
            document.querySelectorAll('.sidebar-brand span, .main-header h5').forEach(el => el.textContent = name);
            document.title = `${name} - Admin`;

            // Colors
            const mode = theme === 'dark' ? 'dark' : 'light';

            const colors = {
                '--primary-color': configs[`system_primary_color_${mode}`] || (theme === 'dark' ? '#2997ff' : '#0071e3'),
                '--secondary-color': configs[`system_secondary_color_${mode}`] || (theme === 'dark' ? '#98989d' : '#86868b'),
                '--success-color': configs[`system_success_color_${mode}`] || (theme === 'dark' ? '#30d158' : '#34c759'),
                '--warning-color': configs[`system_warning_color_${mode}`] || (theme === 'dark' ? '#ff9f0a' : '#ff9f0a'),
                '--danger-color': configs[`system_danger_color_${mode}`] || (theme === 'dark' ? '#ff453a' : '#ff3b30')
            };

            Object.entries(colors).forEach(([key, value]) => {
                root.style.setProperty(key, value);

                // Set Bootstrap RGB variables for opacity utilities
                const rgb = hexToRgb(value);
                if (rgb) {
                    const bsVar = key.replace('--', '--bs-').replace('-color', '-rgb'); // e.g. --bs-primary-rgb
                    root.style.setProperty(bsVar, rgb);
                }
            });
        }

        async function loadBranding() {
            try {
                // Try to get from localStorage first for speed
                const cached = localStorage.getItem('systemConfigs');
                if (cached) {
                    systemConfigs = JSON.parse(cached);
                    applyBranding(savedTheme);
                }

                // Fetch fresh from API
                const data = await apiCall('/api/admin/config');
                if (data.configs) {
                    systemConfigs = data.configs.reduce((acc, curr) => {
                        acc[curr.chave] = curr.valor;
                        return acc;
                    }, {});
                    localStorage.setItem('systemConfigs', JSON.stringify(systemConfigs));
                    applyBranding(document.documentElement.getAttribute('data-theme'));
                }
            } catch (e) {
                console.error('Error loading branding:', e);
            }
        }

        // Load branding on start
        loadBranding();



        // Restore sidebar state on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedState = localStorage.getItem('sidebarState_v2');
            // Only expand if explicitly set to 'false' (meaning user expanded it)
            if (savedState === 'false') {
                document.querySelector('.sidebar').classList.remove('collapsed');
                document.querySelector('.main-content').classList.remove('expanded');
            }
        });

        // Toast helper
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // API helper
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);

            const response = await fetch(url, options);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'Erro na requisicao');
            }
            return result;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>