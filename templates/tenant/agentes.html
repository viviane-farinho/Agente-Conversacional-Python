{% extends "tenant/base_tenant.html" %}

{% block title %}Agentes - {{ tenant.nome }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-robot me-2"></i>Agentes</h2>
    <button class="btn btn-primary" onclick="mostrarModalAgente()">
        <i class="bi bi-plus-lg me-2"></i>Novo Agente
    </button>
</div>

<div class="row">
    <!-- Lista de Agentes -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-robot me-2"></i>Seus Agentes
            </div>
            <div class="card-body p-0">
                <div id="listaAgentes" class="list-group list-group-flush">
                    <div class="text-center p-4 text-muted">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalhes do Agente -->
    <div class="col-md-8">
        <div class="card" id="cardDetalhes" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-info-circle me-2"></i>Detalhes do Agente</span>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="editarAgente()">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deletarAgente()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 id="agenteNome">-</h5>
                        <p class="text-muted mb-1" id="agenteDescricao">-</p>
                        <p class="mb-1"><strong>Modelo:</strong> <span id="agenteModelo">-</span></p>
                        <p class="mb-1"><strong>Temperatura:</strong> <span id="agenteTemperatura">-</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Chatwoot Account:</strong> <span id="agenteChatwoot">-</span></p>
                        <p class="mb-1"><strong>Chatwoot Inbox:</strong> <span id="agenteInbox">-</span></p>
                        <p class="mb-1"><strong>Status:</strong> <span id="agenteStatus">-</span></p>
                    </div>
                </div>

                <!-- Sub-agentes -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Sub-agentes</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="mostrarModalSubAgente()">
                        <i class="bi bi-plus-lg me-1"></i>Novo Sub-agente
                    </button>
                </div>
                <div id="listaSubAgentes">
                    <p class="text-muted">Nenhum sub-agente cadastrado</p>
                </div>

                <!-- Agentes Vinculados -->
                <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                    <h6 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Agentes Vinculados</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="mostrarModalVincularAgente()">
                        <i class="bi bi-plus-lg me-1"></i>Vincular Agente
                    </button>
                </div>
                <div id="listaAgentesVinculados">
                    <p class="text-muted">Nenhum agente vinculado</p>
                </div>

                <!-- Configuracao Vinculavel -->
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="checkVinculavel" onchange="toggleVinculavel()">
                        <label class="form-check-label" for="checkVinculavel">
                            <strong>Permitir que outros agentes chamem este agente</strong>
                        </label>
                    </div>
                    <small class="text-muted">Se ativado, outros agentes podem transferir conversas para este agente</small>

                    <div id="configVinculavel" style="display: none;" class="mt-3">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">Tipo do Agente</label>
                                <select class="form-select form-select-sm" id="tipoAgente">
                                    <option value="principal">Principal</option>
                                    <option value="financeiro">Financeiro</option>
                                    <option value="suporte">Suporte</option>
                                    <option value="agendamento">Agendamento</option>
                                    <option value="vendas">Vendas</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">Prioridade</label>
                                <input type="number" class="form-control form-control-sm" id="prioridadeAgente" value="0">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Palavras-chave de ativacao</label>
                            <input type="text" class="form-control form-control-sm" id="condicaoAgente" placeholder="financeiro, boleto, pagamento">
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="salvarConfigVinculavel()">Salvar Configuracao</button>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="mt-4">
                    <h6><i class="bi bi-chat-text me-2"></i>System Prompt</h6>
                    <pre class="bg-light p-3 rounded" id="agentePrompt" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">-</pre>
                </div>
            </div>
        </div>

        <!-- Card vazio -->
        <div class="card" id="cardVazio">
            <div class="card-body text-center p-5">
                <i class="bi bi-robot text-muted" style="font-size: 4rem;"></i>
                <p class="text-muted mt-3">Selecione um agente para ver os detalhes</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agente -->
<div class="modal fade" id="modalAgente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgenteTitulo">Novo Agente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="agenteId">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="inputNome" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Modelo LLM</label>
                        <select class="form-select" id="inputModelo">
                            <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                            <option value="openai/gpt-4o">GPT-4o</option>
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Descricao</label>
                    <input type="text" class="form-control" id="inputDescricao">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Chatwoot Account ID</label>
                        <input type="text" class="form-control" id="inputChatwootAccount" placeholder="Ex: 1">
                        <small class="text-muted">ID da conta no Chatwoot para receber mensagens</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Chatwoot Inbox ID</label>
                        <input type="text" class="form-control" id="inputChatwootInbox" placeholder="Ex: 1">
                        <small class="text-muted">Opcional - filtrar por inbox especifica</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Temperatura</label>
                        <input type="number" class="form-control" id="inputTemperatura" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" id="inputMaxTokens" value="4096">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">System Prompt</label>
                    <textarea class="form-control" id="inputPrompt" rows="8" placeholder="Prompt personalizado do agente..."></textarea>
                    <small class="text-muted">Deixe vazio para usar o prompt padrao</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarAgente()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sub-agente -->
<div class="modal fade" id="modalSubAgente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSubAgenteTitulo">Novo Sub-agente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="subAgenteId">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="inputSubNome" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo *</label>
                        <select class="form-select" id="inputSubTipo">
                            <option value="agendamento">Agendamento</option>
                            <option value="informacao">Informacao</option>
                            <option value="cobranca">Cobranca</option>
                            <option value="suporte">Suporte</option>
                            <option value="vendas">Vendas</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Descricao</label>
                    <input type="text" class="form-control" id="inputSubDescricao">
                </div>

                <div class="mb-3">
                    <label class="form-label">Condicao de Ativacao</label>
                    <input type="text" class="form-control" id="inputSubCondicao" placeholder="agendar, marcar, consulta">
                    <small class="text-muted">Palavras-chave que ativam este sub-agente</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-control" id="inputSubPrioridade" value="0">
                    <small class="text-muted">Maior prioridade = avaliado primeiro</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">System Prompt</label>
                    <textarea class="form-control" id="inputSubPrompt" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarSubAgente()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Vincular Agente -->
<div class="modal fade" id="modalVincular" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vincular Agente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Selecione o agente a vincular *</label>
                    <select class="form-select" id="selectAgenteVincular">
                        <option value="">Carregando agentes disponiveis...</option>
                    </select>
                    <small class="text-muted">Apenas agentes configurados como vinculaveis aparecem aqui</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Condicao de ativacao (opcional)</label>
                    <input type="text" class="form-control" id="inputVincularCondicao" placeholder="Ex: financeiro, boleto, pagamento">
                    <small class="text-muted">Sobrescreve a condicao padrao do agente</small>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Modo de transferencia</label>
                        <select class="form-select" id="selectModoTransferencia">
                            <option value="interno">Interno (mesmo chat)</option>
                            <option value="externo">Externo (WhatsApp proprio)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Prioridade</label>
                        <input type="number" class="form-control" id="inputVincularPrioridade" value="0">
                    </div>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkManterContexto" checked>
                    <label class="form-check-label" for="checkManterContexto">
                        Passar historico da conversa para o agente vinculado
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarVinculacao()">Vincular</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let agentes = [];
    let agenteAtual = null;

    document.addEventListener('DOMContentLoaded', () => {
        carregarAgentes();
    });

    async function carregarAgentes() {
        try {
            const data = await apiCall(`/api/admin/tenants/${TENANT_ID}/agentes?apenas_ativos=false`);
            agentes = data.agentes || [];
            renderizarAgentes();
        } catch (error) {
            showToast('Erro ao carregar agentes: ' + error.message, 'danger');
        }
    }

    function renderizarAgentes() {
        const container = document.getElementById('listaAgentes');

        if (agentes.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <i class="bi bi-robot text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2 mb-0">Nenhum agente cadastrado</p>
                </div>
            `;
            return;
        }

        container.innerHTML = agentes.map(a => `
            <a href="#" class="list-group-item list-group-item-action ${agenteAtual?.id === a.id ? 'active' : ''}"
               onclick="selecionarAgente(${a.id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(a.nome)}</strong>
                        <br><small class="text-muted">${escapeHtml(a.modelo_llm)}</small>
                    </div>
                    <span class="badge ${a.ativo ? 'bg-success' : 'bg-secondary'}">${a.ativo ? 'Ativo' : 'Inativo'}</span>
                </div>
            </a>
        `).join('');
    }

    async function selecionarAgente(agenteId) {
        try {
            const data = await apiCall(`/api/admin/agentes/${agenteId}`);
            agenteAtual = data.agente;

            document.getElementById('cardVazio').style.display = 'none';
            document.getElementById('cardDetalhes').style.display = 'block';

            document.getElementById('agenteNome').textContent = agenteAtual.nome;
            document.getElementById('agenteDescricao').textContent = agenteAtual.descricao || 'Sem descricao';
            document.getElementById('agenteModelo').textContent = agenteAtual.modelo_llm;
            document.getElementById('agenteTemperatura').textContent = agenteAtual.temperatura;
            document.getElementById('agenteChatwoot').textContent = agenteAtual.chatwoot_account_id || 'Nao configurado';
            document.getElementById('agenteInbox').textContent = agenteAtual.chatwoot_inbox_id || '-';
            document.getElementById('agenteStatus').innerHTML = agenteAtual.ativo ?
                '<span class="badge bg-success">Ativo</span>' :
                '<span class="badge bg-secondary">Inativo</span>';
            document.getElementById('agentePrompt').textContent = agenteAtual.system_prompt || 'Usando prompt padrao';

            renderizarSubAgentes(agenteAtual.sub_agentes || []);
            renderizarAgentesVinculados(agenteAtual.agentes_vinculados || []);
            atualizarCheckVinculavel();
            renderizarAgentes();
        } catch (error) {
            showToast('Erro ao carregar agente: ' + error.message, 'danger');
        }
    }

    function renderizarSubAgentes(subAgentes) {
        const container = document.getElementById('listaSubAgentes');

        if (!subAgentes || subAgentes.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhum sub-agente cadastrado</p>';
            return;
        }

        container.innerHTML = `
            <div class="list-group">
                ${subAgentes.map(sa => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(sa.nome)}</strong>
                            <span class="badge bg-info ms-2">${escapeHtml(sa.tipo)}</span>
                            ${sa.descricao ? `<br><small class="text-muted">${escapeHtml(sa.descricao)}</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletarSubAgente(${sa.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // --- Modal Agente ---

    function mostrarModalAgente(agente = null) {
        document.getElementById('modalAgenteTitulo').textContent = agente ? 'Editar Agente' : 'Novo Agente';
        document.getElementById('agenteId').value = agente?.id || '';
        document.getElementById('inputNome').value = agente?.nome || '';
        document.getElementById('inputDescricao').value = agente?.descricao || '';
        document.getElementById('inputModelo').value = agente?.modelo_llm || 'google/gemini-2.0-flash-001';
        document.getElementById('inputChatwootAccount').value = agente?.chatwoot_account_id || '';
        document.getElementById('inputChatwootInbox').value = agente?.chatwoot_inbox_id || '';
        document.getElementById('inputTemperatura').value = agente?.temperatura || 0.7;
        document.getElementById('inputMaxTokens').value = agente?.max_tokens || 4096;
        document.getElementById('inputPrompt').value = agente?.system_prompt || '';

        new bootstrap.Modal(document.getElementById('modalAgente')).show();
    }

    function editarAgente() {
        if (agenteAtual) {
            mostrarModalAgente(agenteAtual);
        }
    }

    async function salvarAgente() {
        const id = document.getElementById('agenteId').value;
        const dados = {
            tenant_id: TENANT_ID,
            nome: document.getElementById('inputNome').value,
            descricao: document.getElementById('inputDescricao').value || null,
            modelo_llm: document.getElementById('inputModelo').value,
            chatwoot_account_id: document.getElementById('inputChatwootAccount').value || null,
            chatwoot_inbox_id: document.getElementById('inputChatwootInbox').value || null,
            temperatura: parseFloat(document.getElementById('inputTemperatura').value),
            max_tokens: parseInt(document.getElementById('inputMaxTokens').value),
            system_prompt: document.getElementById('inputPrompt').value || null
        };

        try {
            if (id) {
                await apiCall(`/api/admin/agentes/${id}`, 'PUT', dados);
                showToast('Agente atualizado!');
            } else {
                await apiCall('/api/admin/agentes', 'POST', dados);
                showToast('Agente criado!');
            }

            bootstrap.Modal.getInstance(document.getElementById('modalAgente')).hide();
            await carregarAgentes();

            if (id && agenteAtual?.id == id) {
                await selecionarAgente(id);
            }
        } catch (error) {
            showToast('Erro ao salvar: ' + error.message, 'danger');
        }
    }

    async function deletarAgente() {
        if (!agenteAtual) return;

        if (!confirm(`Deletar o agente "${agenteAtual.nome}"?`)) return;

        try {
            await apiCall(`/api/admin/agentes/${agenteAtual.id}`, 'DELETE');
            showToast('Agente deletado!');
            agenteAtual = null;
            document.getElementById('cardDetalhes').style.display = 'none';
            document.getElementById('cardVazio').style.display = 'block';
            await carregarAgentes();
        } catch (error) {
            showToast('Erro ao deletar: ' + error.message, 'danger');
        }
    }

    // --- Modal Sub-agente ---

    function mostrarModalSubAgente() {
        if (!agenteAtual) {
            showToast('Selecione um agente primeiro', 'warning');
            return;
        }

        document.getElementById('modalSubAgenteTitulo').textContent = 'Novo Sub-agente';
        document.getElementById('subAgenteId').value = '';
        document.getElementById('inputSubNome').value = '';
        document.getElementById('inputSubTipo').value = 'agendamento';
        document.getElementById('inputSubDescricao').value = '';
        document.getElementById('inputSubCondicao').value = '';
        document.getElementById('inputSubPrioridade').value = '0';
        document.getElementById('inputSubPrompt').value = '';

        new bootstrap.Modal(document.getElementById('modalSubAgente')).show();
    }

    async function salvarSubAgente() {
        const dados = {
            agente_id: agenteAtual.id,
            nome: document.getElementById('inputSubNome').value,
            tipo: document.getElementById('inputSubTipo').value,
            descricao: document.getElementById('inputSubDescricao').value || null,
            condicao_ativacao: document.getElementById('inputSubCondicao').value || null,
            prioridade: parseInt(document.getElementById('inputSubPrioridade').value),
            system_prompt: document.getElementById('inputSubPrompt').value || null
        };

        try {
            await apiCall('/api/admin/sub-agentes', 'POST', dados);
            showToast('Sub-agente criado!');
            bootstrap.Modal.getInstance(document.getElementById('modalSubAgente')).hide();
            await selecionarAgente(agenteAtual.id);
        } catch (error) {
            showToast('Erro ao salvar: ' + error.message, 'danger');
        }
    }

    async function deletarSubAgente(subAgenteId) {
        if (!confirm('Deletar este sub-agente?')) return;

        try {
            await apiCall(`/api/admin/sub-agentes/${subAgenteId}`, 'DELETE');
            showToast('Sub-agente deletado!');
            await selecionarAgente(agenteAtual.id);
        } catch (error) {
            showToast('Erro ao deletar: ' + error.message, 'danger');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- Agentes Vinculados ---

    function renderizarAgentesVinculados(vinculados) {
        const container = document.getElementById('listaAgentesVinculados');

        if (!vinculados || vinculados.length === 0) {
            container.innerHTML = '<p class="text-muted">Nenhum agente vinculado</p>';
            return;
        }

        container.innerHTML = `
            <div class="list-group">
                ${vinculados.map(av => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(av.agente_nome)}</strong>
                            <span class="badge bg-primary ms-2">${escapeHtml(av.agente_tipo)}</span>
                            <span class="badge ${av.modo_transferencia === 'interno' ? 'bg-success' : 'bg-warning'} ms-1">
                                ${av.modo_transferencia === 'interno' ? 'Interno' : 'Externo'}
                            </span>
                            ${av.condicao_ativacao ? `<br><small class="text-muted">Ativacao: ${escapeHtml(av.condicao_ativacao)}</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="desvincularAgente(${av.agente_id})">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function atualizarCheckVinculavel() {
        if (!agenteAtual) return;

        const check = document.getElementById('checkVinculavel');
        const config = document.getElementById('configVinculavel');

        check.checked = agenteAtual.pode_ser_vinculado || false;
        config.style.display = check.checked ? 'block' : 'none';

        if (check.checked) {
            document.getElementById('tipoAgente').value = agenteAtual.tipo || 'principal';
            document.getElementById('prioridadeAgente').value = agenteAtual.prioridade || 0;
            document.getElementById('condicaoAgente').value = agenteAtual.condicao_ativacao || '';
        }
    }

    function toggleVinculavel() {
        const check = document.getElementById('checkVinculavel');
        const config = document.getElementById('configVinculavel');
        config.style.display = check.checked ? 'block' : 'none';
    }

    async function salvarConfigVinculavel() {
        if (!agenteAtual) return;

        const dados = {
            pode_ser_vinculado: document.getElementById('checkVinculavel').checked,
            tipo: document.getElementById('tipoAgente').value,
            prioridade: parseInt(document.getElementById('prioridadeAgente').value),
            condicao_ativacao: document.getElementById('condicaoAgente').value || null
        };

        try {
            await apiCall(`/api/admin/agentes/${agenteAtual.id}/vinculavel`, 'PUT', dados);
            showToast('Configuracao salva!');
            await selecionarAgente(agenteAtual.id);
        } catch (error) {
            showToast('Erro ao salvar: ' + error.message, 'danger');
        }
    }

    async function mostrarModalVincularAgente() {
        if (!agenteAtual) {
            showToast('Selecione um agente primeiro', 'warning');
            return;
        }

        // Carrega agentes vinculaveis
        try {
            const data = await apiCall(`/api/admin/agentes/vinculaveis?tenant_id=${TENANT_ID}&excluir_agente_id=${agenteAtual.id}`);
            const select = document.getElementById('selectAgenteVincular');

            if (data.agentes_vinculaveis.length === 0) {
                select.innerHTML = '<option value="">Nenhum agente vinculavel disponivel</option>';
            } else {
                select.innerHTML = '<option value="">Selecione...</option>' +
                    data.agentes_vinculaveis.map(a =>
                        `<option value="${a.id}">${escapeHtml(a.nome)} (${escapeHtml(a.tipo)})</option>`
                    ).join('');
            }

            // Limpa campos
            document.getElementById('inputVincularCondicao').value = '';
            document.getElementById('selectModoTransferencia').value = 'interno';
            document.getElementById('inputVincularPrioridade').value = '0';
            document.getElementById('checkManterContexto').checked = true;

            new bootstrap.Modal(document.getElementById('modalVincular')).show();
        } catch (error) {
            showToast('Erro ao carregar agentes: ' + error.message, 'danger');
        }
    }

    async function salvarVinculacao() {
        const agenteVinculadoId = document.getElementById('selectAgenteVincular').value;
        if (!agenteVinculadoId) {
            showToast('Selecione um agente', 'warning');
            return;
        }

        const dados = {
            agente_principal_id: agenteAtual.id,
            agente_vinculado_id: parseInt(agenteVinculadoId),
            condicao_ativacao: document.getElementById('inputVincularCondicao').value || null,
            modo_transferencia: document.getElementById('selectModoTransferencia').value,
            prioridade: parseInt(document.getElementById('inputVincularPrioridade').value),
            manter_contexto: document.getElementById('checkManterContexto').checked
        };

        try {
            await apiCall('/api/admin/agentes/vincular', 'POST', dados);
            showToast('Agente vinculado com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('modalVincular')).hide();
            await selecionarAgente(agenteAtual.id);
        } catch (error) {
            showToast('Erro ao vincular: ' + error.message, 'danger');
        }
    }

    async function desvincularAgente(agenteVinculadoId) {
        if (!confirm('Deseja desvincular este agente?')) return;

        try {
            await apiCall(`/api/admin/agentes/${agenteAtual.id}/desvincular/${agenteVinculadoId}`, 'DELETE');
            showToast('Agente desvinculado!');
            await selecionarAgente(agenteAtual.id);
        } catch (error) {
            showToast('Erro ao desvincular: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %}
